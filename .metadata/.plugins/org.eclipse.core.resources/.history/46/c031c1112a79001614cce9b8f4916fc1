package org.gauntlet.quizzes.dao.impl;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.persistence.EntityManager;
import javax.persistence.criteria.CriteriaBuilder;
import javax.persistence.criteria.CriteriaQuery;
import javax.persistence.criteria.ParameterExpression;
import javax.persistence.criteria.Root;

import org.amdatu.jta.Transactional;
import org.gauntlet.core.api.ApplicationException;
import org.gauntlet.core.api.dao.NoSuchModelException;
import org.gauntlet.core.commons.util.Validator;
import org.gauntlet.core.commons.util.jpa.JPAEntityUtil;
import org.gauntlet.core.model.JPABaseEntity;
import org.gauntlet.core.service.impl.BaseServiceImpl;
import org.osgi.service.log.LogService;
import org.gauntlet.quizzes.api.dao.IQuizDAOService;
import org.gauntlet.quizzes.api.model.Quiz;
import org.gauntlet.quizzes.api.model.QuizType;
import org.gauntlet.quizzes.api.model.ProblemDifficulty;
import org.gauntlet.quizzes.api.model.ProblemSource;
import org.gauntlet.quizzes.model.jpa.JPAProblem;
import org.gauntlet.quizzes.model.jpa.JPAProblemCategory;
import org.gauntlet.quizzes.model.jpa.JPAProblemDifficulty;
import org.gauntlet.quizzes.model.jpa.JPAProblemSource;


@SuppressWarnings("restriction")
@Transactional
public class ProblemDAOImpl extends BaseServiceImpl implements IQuizDAOService {
	//Problems
	private volatile LogService logger;
	
	private volatile EntityManager em;
	
	@Override
	public LogService getLogger() {
		return logger;
	}

	public void setLogger(LogService logger) {
		this.logger = logger;
	}

	@Override
	public EntityManager getEm() {
		return em;
	}	
	
	@Override
	public List<Quiz> findAll(int start, int end) throws ApplicationException {
		List<Quiz> result = new ArrayList<>();
		try {
			List<JPABaseEntity> resultList = super.findAll(JPAProblem.class,start,end);
			result = JPAEntityUtil.copy(resultList, Quiz.class);
		}
		catch (Exception e) {
			throw processException(e);
		}
		return result;		
	}
	
	@Override
	public long countAll() throws ApplicationException {
		long res = 0;
		try {
			res = super.countAll(JPAProblem.class);
		}
		catch (Exception e) {
			throw processException(e);
		}
		return res;
	}	
	
	@Override
	public Quiz getByPrimary(Long pk) throws ApplicationException, NoSuchModelException {
		JPAProblem jpaEntity = (JPAProblem) super.findByPrimaryKey(JPAProblem.class, pk);
		return JPAEntityUtil.copy(jpaEntity, Quiz.class);
	}

	@Override
	public Quiz provide(Quiz record)
			  throws ApplicationException {
		Quiz existingCountry = getByCode(record.getCode());
		if (Validator.isNull(existingCountry))
		{
			JPABaseEntity res = super.add(JPAEntityUtil.copy(record, JPAProblem.class));
			existingCountry = JPAEntityUtil.copy(res, Quiz.class);
		}

		return existingCountry;
	}
	
	@Override
	public Quiz update(Quiz record) throws ApplicationException {
		JPABaseEntity res = super.update(JPAEntityUtil.copy(record, JPAProblem.class));
		Quiz dto = JPAEntityUtil.copy(res, Quiz.class);
		return dto;	
	}	
	
	@Override
	public Quiz delete(Long id) throws ApplicationException, NoSuchModelException {
		JPAProblem jpaEntity = (JPAProblem) super.findByPrimaryKey(JPAProblem.class, id);
		super.remove(jpaEntity);
		return JPAEntityUtil.copy(jpaEntity, Quiz.class);
	}
	
	@Override
	public Quiz getByCode(String code) throws ApplicationException {
		JPAProblem jpaEntity = (JPAProblem) super.findWithAttribute(JPAProblem.class, String.class,"code", code);
		return JPAEntityUtil.copy(jpaEntity, Quiz.class);
	}


	@Override
	public Quiz getByName(String name) throws ApplicationException {
		JPAProblem jpaEntity = (JPAProblem) super.findWithAttribute(JPAProblem.class, String.class,"name", name);
		return JPAEntityUtil.copy(jpaEntity, Quiz.class);
	}
	
	@Override 
	public List<Quiz> findByDifficulty(Long difficultyId, int start, int end) throws ApplicationException {
		List<Quiz> resultList = null;
		try {
			CriteriaBuilder builder = getEm().getCriteriaBuilder();
			CriteriaQuery<JPAProblem> query = builder.createQuery(JPAProblem.class);
			Root<JPAProblem> rootEntity = query.from(JPAProblem.class);
			
			ParameterExpression<Long> p = builder.parameter(Long.class);
			query.select(rootEntity).where(builder.gt(rootEntity.get("difficulty").get("id"),p));
			query.select(rootEntity);
			
			Map<ParameterExpression,Object> pes = new HashMap<>();
			pes.put(p, difficultyId);
			
			resultList = findWithDynamicQueryAndParams(query,pes,start,end);
		}
		catch (Exception e) {
			throw processException(e);
		}
		return resultList;		
	}
	
	@Override 
	public int countByDifficulty(Long difficultyId) throws ApplicationException {
		int count = 0;
		try {
			CriteriaBuilder builder = getEm().getCriteriaBuilder();
			CriteriaQuery<JPAProblem> query = builder.createQuery(JPAProblem.class);
			Root<JPAProblem> rootEntity = query.from(JPAProblem.class);
			
			ParameterExpression<Long> p = builder.parameter(Long.class);
			query.select(rootEntity).where(builder.gt(rootEntity.get("difficulty").get("id"),p));
			query.select(rootEntity);
			
			Map<ParameterExpression,Object> pes = new HashMap<>();
			pes.put(p, difficultyId);
			
			count = countWithDynamicQueryAndParams(query,pes);
		}
		catch (Exception e) {
			throw processException(e);
		}
		return count;		
	}	
	
	//ProblemDifficulty
	@Override 
	public List<ProblemDifficulty> findAllProblemDifficulties(int start, int end) throws ApplicationException {
		List<ProblemDifficulty> result = new ArrayList<>();
		try {
			List<JPABaseEntity> resultList = super.findAll(JPAProblemDifficulty.class,start,end);
			result = JPAEntityUtil.copy(resultList, ProblemDifficulty.class);
		}
		catch (Exception e) {
			throw processException(e);
		}
		return result;		
	}
	
	@Override
	public long countAllProblemDifficulties() throws ApplicationException {
		long res = 0;
		try {
			res = super.countAll(JPAProblemDifficulty.class);
		}
		catch (Exception e) {
			throw processException(e);
		}
		return res;
	}	
	
	@Override
	public ProblemDifficulty getProblemDifficultyByPrimary(Long pk) throws ApplicationException, NoSuchModelException {
		JPAProblemDifficulty jpaEntity = (JPAProblemDifficulty) super.findByPrimaryKey(JPAProblemDifficulty.class, pk);
		return JPAEntityUtil.copy(jpaEntity, ProblemDifficulty.class);
	}
	
	@Override 
	public ProblemDifficulty provideProblemDifficulty(ProblemDifficulty record) throws ApplicationException {
		ProblemDifficulty existingCountry = getProblemDifficultyByCode(record.getCode());
		if (Validator.isNull(existingCountry))
		{
			JPABaseEntity res = super.add(JPAEntityUtil.copy(record, JPAProblemDifficulty.class));
			existingCountry = JPAEntityUtil.copy(res, ProblemDifficulty.class);
		}

		return existingCountry;	
	}
	
	public ProblemDifficulty updateProblemDifficulty(JPAProblemDifficulty record) throws ApplicationException {
		JPABaseEntity res = super.update(JPAEntityUtil.copy(record, JPAProblemDifficulty.class));
		ProblemDifficulty dto = JPAEntityUtil.copy(res, ProblemDifficulty.class);
		return dto;	
	}	
	
	public ProblemDifficulty getProblemDifficultyByCode(String code) throws ApplicationException{
		JPAProblemDifficulty jpaEntity = (JPAProblemDifficulty) super.findWithAttribute(JPAProblemDifficulty.class, String.class,"code", code);
		return JPAEntityUtil.copy(jpaEntity, ProblemDifficulty.class);		
	}
	
	public ProblemDifficulty getProblemDifficultyByName(String code) throws ApplicationException{
		JPAProblemDifficulty jpaEntity = (JPAProblemDifficulty) super.findWithAttribute(JPAProblemDifficulty.class, String.class,"name", code);
		return JPAEntityUtil.copy(jpaEntity, ProblemDifficulty.class);		
	}
	
	public ProblemDifficulty deleteProblemDifficulty(Long id) throws ApplicationException, NoSuchModelException {
		JPAProblemDifficulty jpaEntity = (JPAProblemDifficulty) super.findByPrimaryKey(JPAProblemDifficulty.class, id);
		super.remove(jpaEntity);
		return JPAEntityUtil.copy(jpaEntity, ProblemDifficulty.class);
	}
		
	
	//ProblemCategory
	@Override 
	public List<QuizType> findAllProblemCategories(int start, int end) throws ApplicationException {
		List<QuizType> result = new ArrayList<>();
		try {
			List<JPABaseEntity> resultList = super.findAll(JPAProblemCategory.class,start,end);
			result = JPAEntityUtil.copy(resultList, QuizType.class);
		}
		catch (Exception e) {
			throw processException(e);
		}
		return result;		
	}
	
	@Override
	public long countAllProblemCategories() throws ApplicationException {
		long res = 0;
		try {
			res = super.countAll(JPAProblemCategory.class);
		}
		catch (Exception e) {
			throw processException(e);
		}
		return res;
	}	
	
	@Override
	public QuizType getProblemCategoryByPrimary(Long pk) throws ApplicationException, NoSuchModelException {
		JPAProblemCategory jpaEntity = (JPAProblemCategory) super.findByPrimaryKey(JPAProblemCategory.class, pk);
		return JPAEntityUtil.copy(jpaEntity, QuizType.class);
	}
	
	@Override 
	public QuizType provideProblemCategory(QuizType record) throws ApplicationException {
		QuizType existingCountry = getProblemCategoryByCode(record.getCode());
		if (Validator.isNull(existingCountry))
		{
			JPABaseEntity res = super.add(JPAEntityUtil.copy(record, JPAProblemCategory.class));
			existingCountry = JPAEntityUtil.copy(res, QuizType.class);
		}

		return existingCountry;	
	}
	
	public QuizType updateProblemCategory(JPAProblemCategory record) throws ApplicationException {
		JPABaseEntity res = super.update(JPAEntityUtil.copy(record, JPAProblemCategory.class));
		QuizType dto = JPAEntityUtil.copy(res, QuizType.class);
		return dto;	
	}	
	
	public QuizType getProblemCategoryByCode(String code) throws ApplicationException{
		JPAProblemCategory jpaEntity = (JPAProblemCategory) super.findWithAttribute(JPAProblemCategory.class, String.class,"code", code);
		return JPAEntityUtil.copy(jpaEntity, QuizType.class);		
	}
	
	public QuizType getProblemCategoryByName(String code) throws ApplicationException{
		JPAProblemCategory jpaEntity = (JPAProblemCategory) super.findWithAttribute(JPAProblemCategory.class, String.class,"name", code);
		return JPAEntityUtil.copy(jpaEntity, QuizType.class);		
	}
	
	public QuizType deleteProblemCategory(Long id) throws ApplicationException, NoSuchModelException {
		JPAProblemCategory jpaEntity = (JPAProblemCategory) super.findByPrimaryKey(JPAProblemCategory.class, id);
		super.remove(jpaEntity);
		return JPAEntityUtil.copy(jpaEntity, QuizType.class);
	}	
	
	//ProblemSource
	@Override 
	public List<ProblemSource> findAllProblemSources(int start, int end) throws ApplicationException {
		List<ProblemSource> result = new ArrayList<>();
		try {
			List<JPABaseEntity> resultList = super.findAll(JPAProblemSource.class,start,end);
			result = JPAEntityUtil.copy(resultList, ProblemSource.class);
		}
		catch (Exception e) {
			throw processException(e);
		}
		return result;		
	}
	
	@Override
	public long countAllProblemSources() throws ApplicationException {
		long res = 0;
		try {
			res = super.countAll(JPAProblemSource.class);
		}
		catch (Exception e) {
			throw processException(e);
		}
		return res;
	}	
	
	@Override
	public ProblemSource getProblemSourceByPrimary(Long pk) throws ApplicationException, NoSuchModelException {
		JPAProblemSource jpaEntity = (JPAProblemSource) super.findByPrimaryKey(JPAProblemSource.class, pk);
		return JPAEntityUtil.copy(jpaEntity, ProblemSource.class);
	}
	
	@Override 
	public ProblemSource provideProblemSource(ProblemSource record) throws ApplicationException {
		ProblemSource existingCountry = getProblemSourceByCode(record.getCode());
		if (Validator.isNull(existingCountry))
		{
			JPABaseEntity res = super.add(JPAEntityUtil.copy(record, JPAProblemSource.class));
			existingCountry = JPAEntityUtil.copy(res, ProblemSource.class);
		}

		return existingCountry;	
	}
	
	public ProblemSource updateProblemSource(JPAProblemSource record) throws ApplicationException {
		JPABaseEntity res = super.update(JPAEntityUtil.copy(record, JPAProblemSource.class));
		ProblemSource dto = JPAEntityUtil.copy(res, ProblemSource.class);
		return dto;	
	}	
	
	public ProblemSource getProblemSourceByCode(String code) throws ApplicationException{
		JPAProblemSource jpaEntity = (JPAProblemSource) super.findWithAttribute(JPAProblemSource.class, String.class,"code", code);
		return JPAEntityUtil.copy(jpaEntity, ProblemSource.class);		
	}
	
	public ProblemSource getProblemSourceByName(String code) throws ApplicationException{
		JPAProblemSource jpaEntity = (JPAProblemSource) super.findWithAttribute(JPAProblemSource.class, String.class,"name", code);
		return JPAEntityUtil.copy(jpaEntity, ProblemSource.class);		
	}
	
	public ProblemSource deleteProblemSource(Long id) throws ApplicationException, NoSuchModelException {
		JPAProblemSource jpaEntity = (JPAProblemSource) super.findByPrimaryKey(JPAProblemSource.class, id);
		super.remove(jpaEntity);
		return JPAEntityUtil.copy(jpaEntity, ProblemSource.class);
	}

	@Override
	public void createDefaults() throws ApplicationException {
	}	
}